<!DOCTYPE html>
<html>
<head>
  <style>
    .search-container {
      padding: 10px;
      background-color: #f1f1f1;
    }

    #search-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #map {
      width: 100%;
      height: 300px;
    }

    .toggle-button {
      margin-top: 10px;
      padding: 5px 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="search-container">
    <input id="search-input" type="text" placeholder="Search for locations">
    <button class="toggle-button" onclick="viewAll()">View All</button>
    <button class="toggle-button" onclick="viewClients()">View Clients</button>
  </div>

  <div id="map"></div>

  <script>
    var map;
    var markers = [];
    var infoWindow;
    var searchRadius = 5000;
    var searchCircle;
    var centerMarker;
    
    // Custom clients for testing
    var clientHospitals = [
        { name: "Client Hospital 1", lat: -33.87322729582937, lng: 151.22264216085205 },
        { name: "Client Hospital 2", lat: -37.87322729582937, lng: 155.22264216085205 }
    ];
    ///////////////////////////

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -31.840233, lng: 145.612793 },
        zoom: 7
      });

      infoWindow = new google.maps.InfoWindow();
      var searchBox = new google.maps.places.SearchBox(document.getElementById('search-input'));

      map.addListener('bounds_changed', function () {
        searchBox.setBounds(map.getBounds());
      });

      searchBox.addListener('places_changed', function () {
        clearMarkers();
        var places = searchBox.getPlaces();
        if (places.length === 0) return;

        var location = places[0].geometry.location;
        map.setCenter(location);
        map.setZoom(15);

        // Draw a circle around the search location
        if (searchCircle) searchCircle.setMap(null);
        searchCircle = new google.maps.Circle({
          strokeColor: 'white',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: 'lightblue',
          fillOpacity: 0.35,
          map: map,
          center: location,
          radius: searchRadius,
        });

        // Place a marker at the center of the circle
        if (centerMarker) centerMarker.setMap(null);
        centerMarker = new google.maps.Marker({
            map: map,
            position: location,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 5,
                fillColor: 'blue',
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 1
            }
        });

        // Adjust map view to fit the circle
        map.fitBounds(searchCircle.getBounds());

        searchNearbyPlaces(location, ['hospital', 'health', 'doctor']);
        searchWithKeyword(location, 'aged care');
        displayHospitals(clientHospitals, 'black');
      });
    }

    function searchNearbyPlaces(location, types) {
        var service = new google.maps.places.PlacesService(map);
        types.forEach(function(type) {
            service.nearbySearch({
                location: location,
                radius: searchRadius,
                type: type
            }, callback);
        });
    }

    function searchWithKeyword(location, keyword) {
        var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
            location: location,
            radius: searchRadius,
            keyword: keyword
        }, callback);
    }

    function callback(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            results.forEach(function(place) {
                if (!place.types.includes('lodging') && 
                    (place.types.some(type => ['hospital', 'health', 'doctor'].includes(type)) || 
                     place.name.toLowerCase().includes('age care'))) {
                    createMarker(place);
                }
            });
        }
    }

    function createMarker(place, icon = null) {
        var marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            icon: getMarkerIcon(place.types) // Call a function to get the appropriate marker icon based on place types
        });
        markers.push(marker);
        marker.addListener('click', function () {
            showPlaceInfo(place, marker);
        });
    }

    function getMarkerIcon(types) {
        var iconColor = 'orange'; // Default color
        types.forEach(function(type) {
            if (type === 'hospital') {
                iconColor = 'red'; // Assign red color for hospitals
            } else if (type === 'doctor') {
                iconColor = 'yellow'; // Assign yellow color for doctors
            }
        });

        return {
            path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
            scale: 5,
            fillColor: iconColor,
            fillOpacity: 1,
            strokeColor: 'white',
            strokeWeight: 1
        };
    }

    function showPlaceInfo(place, marker) {
        var service = new google.maps.places.PlacesService(map);
        service.getDetails({ placeId: place.place_id }, function(result, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                var content = '<strong>' + result.name + '</strong><br>' +
                                            'Address: ' + result.vicinity + '<br>' +
                                            'Rating: ' + (result.rating || 'N/A') + '<br>' +
                                            'Phone: ' + (result.formatted_phone_number || 'N/A');

                if (result.opening_hours) {
                    content += '<br>Opening hours:<br>' + result.opening_hours.weekday_text.join('<br>');
                }

                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            }
        });
    }

    function clearMarkers() {
      markers.forEach(function(marker) {
        marker.setMap(null);
      });
      markers = [];
    }

    function viewAll() {
      clearMarkers();
      var location = map.getCenter();
      viewClients();
      searchNearbyPlaces(location, ['hospital', 'health', 'doctor']);
      searchWithKeyword(location, 'aged care');
    }

    function viewClients() {
      clearMarkers();
      displayHospitals(clientHospitals, 'black');
    }

    function displayHospitals(hospitals, color) {
      hospitals.forEach(function(hospital) {
        var marker = new google.maps.Marker({
          map: map,
          position: { lat: hospital.lat, lng: hospital.lng },
          icon: {
            path: google.maps.SymbolPath.BACKWARD_OPEN_ARROW,
            scale: 5,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: 'white',
            strokeWeight: 1
          }
        });
        markers.push(marker);
        marker.addListener('click', function () {
          infoWindow.setContent('<strong>' + hospital.name + '</strong>');
          infoWindow.open(map, marker);
        });
      });
    }
    

    
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAmvAFl_dcSorl6jEXtgd-NzAQA_j6wrA&libraries=places&callback=initMap" async defer></script>
</body>
</html>
