<!DOCTYPE html>
<html>
<head>
  <style>
    .search-container {
      padding: 10px;
      background-color: #f1f1f1;
    }

    #search-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #map {
      width: 100%;
      height: 300px;
    }

    .toggle-button {
      margin-top: 10px;
      padding: 5px 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="search-container">
    <input id="search-input" type="text" placeholder="Search for locations">
    <button class="toggle-button" onclick="viewAll()">View All</button>
    <button class="toggle-button" onclick="viewClients()">View Clients</button>
    <button class="toggle-button" onclick="viewSector('hospital')">View Hospitals</button>
    <button class="toggle-button" onclick="viewSector('aged care')">View Aged Care</button>
    <button class="toggle-button" onclick="viewSector('doctor')">View Doctors</button>

  </div>

  <div id="map"></div>

  <script>
    var map;
    var markers = [];
    var infoWindow;
    var searchRadius = 5000;
    var searchCircle;
    var centerMarker;
    
    // Custom clients for testing
    var clientHospitals = [
        { name: "Client Hospital 1", lat: -33.87322729582937, lng: 151.22264216085205 },
        { name: "Client Hospital 2", lat: -33.86322729582937, lng: 155.22264216085205 },
        { name: "Client Hospital 3", lat: -33.88322729582937, lng: 151.23264216085205 },
        { name: "Client Hospital 4", lat: -33.67322729582937, lng: 151.23464216085205 },
        { name: "Client Hospital 5", lat: -32.15322729582937, lng: 150.26264216085205 },
        { name: "Client Hospital 6", lat: -33.82322729582937, lng: 153.23264216085205 },
        { name: "Client Hospital 7", lat: -33.82322729582937, lng: 153.23264216085205 },
    ];

    ///////////////////////////

    async function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -31.840233, lng: 145.612793 },
        zoom: 7,
        styles: [
                {
                    "featureType": "poi",
                    "stylers": [{ "visibility": "off" }]  // Hides points of interest
                },
                {
                    "featureType": "poi.business",
                    "stylers": [{ "visibility": "off" }]  // Specifically hides businesses
                }
                // Add more style features as needed
            ]
      });

      infoWindow = new google.maps.InfoWindow();
      var searchBox = new google.maps.places.SearchBox(document.getElementById('search-input'));
      var distanceMatrixService = new google.maps.DistanceMatrixService();

      map.addListener('bounds_changed', function () {
        searchBox.setBounds(map.getBounds());
      });

      searchBox.addListener('places_changed', function () {
        clearMarkers();
        var places = searchBox.getPlaces();
        if (places.length === 0) return;

        var location = places[0].geometry.location;
        map.setCenter(location);
        map.setZoom(15);

        // Draw a circle around the search location
        if (searchCircle) searchCircle.setMap(null);
        searchCircle = new google.maps.Circle({
          strokeColor: 'white',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: 'lightblue',
          fillOpacity: 0.35,
          map: map,
          center: location,
          radius: searchRadius,
        });

        // Place a marker at the center of the circle
        if (centerMarker) centerMarker.setMap(null);
        centerMarker = new google.maps.Marker({
            map: map,
            position: location,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 5,
                fillColor: 'blue',
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 1
            }
        });

        // Create the client markers
        var clients = JSON.parse(localStorage.getItem('clients')) || [];
        for (var i = 0; i < clients.length; i++) {
            var clientMarker = new google.maps.Marker({
                map: map,
                position: clients[i].geometry.location,
                icon: {
                    path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                    scale: 5,
                    fillColor: 'black',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 1
                }
            });
        }

        // Adjust map view to fit the circle
        map.fitBounds(searchCircle.getBounds());

        searchNearbyPlaces(location, ['hospital', 'health', 'doctor']);
        searchWithKeyword(location, 'aged care');
        displayClients(clientHospitals, 'black');
      });
    }

    function searchNearbyPlaces(location, types) {
        var service = new google.maps.places.PlacesService(map);
        types.forEach(function(type) {
            service.nearbySearch({
                location: location,
                radius: searchRadius * 2,
                type: type
            }, callback);
        });
    }

    function searchWithKeyword(location, keyword) {
        var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
            location: location,
            radius: searchRadius * 2,
            keyword: keyword
        }, callback);
    }

    function callback(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            results.forEach(function(place) {
                if (!place.types.includes('lodging') && 
                    (place.types.some(type => ['hospital', 'health', 'doctor'].includes(type)) || 
                     place.name.toLowerCase().includes('age care'))) {
                    createMarker(place);
                }
            });
        }
    }

    function createMarker(place) {
        var iconColor = getMarkerIcon(place.types);
        var marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            icon: iconColor ? {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 5,
                fillColor: iconColor,
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 1
            } : null
        });

        marker.addListener('rightclick', function() {
            markAsClient(marker, place);
        });

        markers.push(marker);

        marker.addListener('click', function() {
            showPlaceInfo(place, marker);
        });
    } 


    function getMarkerIcon(types) {
        if (types.includes('hospital')) {
            return 'red'; // Red color for hospitals
        } else if (types.includes('doctor')) {
            return 'yellow'; // Yellow color for doctors
        } else  {
            return 'orange'; // Blue color for aged care
        }
    }

    function showPlaceInfo(place, marker) {
        var service = new google.maps.places.PlacesService(map);
        service.getDetails({ placeId: place.place_id }, function(result, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                var content = '<strong>' + result.name + '</strong><br>' +
                                            'Address: ' + result.vicinity + '<br>' +
                                            'Rating: ' + (result.rating || 'N/A') + '<br>' +
                                            'Phone: ' + (result.formatted_phone_number || 'N/A');

                if (result.opening_hours) {
                    content += '<br>Opening hours:<br>' + result.opening_hours.weekday_text.join('<br>');
                }

                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            }
        });
    }

    function clearMarkers() {
      markers.forEach(function(marker) {
        marker.setMap(null);
      });
      markers = [];
    }

    function viewAll() {
      clearMarkers();
      var location = map.getCenter();
      viewClients();
      searchNearbyPlaces(location, ['hospital', 'health', 'doctor']);
      searchWithKeyword(location, 'aged care');
    }

    function viewClients() {
      clearMarkers();
      displayClients(clientHospitals, 'black');
      /*
      fetchClientHospitalsFromVincere()
        .then(clientHospitals => {
            clearMarkers();
            displayClients(clientHospitals, 'black');
        })
        .catch(error => console.error('Error fetching client hospitals:', error));
      */
    }
    
    function viewSector(sector) {
      clearMarkers();
      var location = map.getCenter();

      if (sector === 'hospital' || sector === 'doctor') {
          searchNearbyPlaces(location, [sector]);
      } else if (sector === 'aged care') {
          searchWithKeyword(location, 'aged care');
      }
    }

    function displayClients(places, color) {
      places.forEach(function(hospital) {
        var marker = new google.maps.Marker({
          map: map,
          position: { lat: hospital.lat, lng: hospital.lng },
          icon: {
            path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
            scale: 5,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: 'white',
            strokeWeight: 1
          }
        });
        markers.push(marker);
        marker.addListener('click', function () {
          infoWindow.setContent('<strong>' + hospital.name + '</strong>');
          infoWindow.open(map, marker);
        });
      });
    }
    
    /* Function for getting client hospitals from Vincere's API
    function fetchClientHospitalsFromVincere() {
    return fetch('https://api.vincere.io/endpoint-for-client-hospitals', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer YOUR_ACCESS_TOKEN',
            // Additional headers as required by Vincere's API
        }
    })
    .then(response => response.json())
    .then(data => {
        // Process the data to fit the format expected by displayHospitals
        // This depends on the structure of the data returned by Vincere
        return data.map(item => ({
            name: item.hospitalName, // Replace with actual property names
            lat: item.latitude,
            lng: item.longitude
        }));
    });
    }
    */ 

    function markAsClient(marker, place) {
      // Retrieve clients from local storage
      var clients = JSON.parse(localStorage.getItem('clients'));

      // If clients is not an array, initialize it as an array
      if (!Array.isArray(clients)) {
        clients = [];
      }

      // Push the new client to the array
      clients.push(place);

      // Save clients back to local storage
      localStorage.setItem('clients', JSON.stringify(clients));

      // Create a new marker with a different icon
      var clientMarker = new google.maps.Marker({
        map: map,
        position: marker.getPosition(),
        icon: {
          path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
          scale: 5,
          fillColor: 'black',
          fillOpacity: 1,
          strokeColor: 'white',
          strokeWeight: 1
        }
      });
      
      // On click of the client marker, show the place info
      clientMarker.addListener('click', function() {
        showPlaceInfo(place, clientMarker);
      });

    }


  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8RnGZuqIQDLEDn-j-JhTNhQOvI9dl9W8&libraries=places&callback=initMap" async defer></script>
</body>
</html>
